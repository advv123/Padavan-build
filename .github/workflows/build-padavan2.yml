name: Build Padavan2

on:
  workflow_dispatch:
  push:
    branches:
      - master
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-22.04
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Initialization environment
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo apt-get update
          sudo apt-get -y install unzip libtool-bin curl cmake gperf gawk flex bison nano xxd fakeroot \
            cpio git python3-docutils gettext automake autopoint texinfo build-essential help2man \
            pkg-config zlib1g-dev libgmp3-dev libmpc-dev libmpfr-dev libncurses5-dev libltdl-dev wget

      - name: Clone source
        run: |
          git clone --depth=1 https://github.com/advv123/rt-n56u.git /opt/rt-n56u
          cd /opt/rt-n56u/toolchain-mipsel
          sh dl_toolchain.sh
          mkdir -p /opt/images/

      - name: Fix Go download
        run: |
          cd /opt/rt-n56u/trunk/tools
          sed -i 's#go1.15.2.linux-amd64.tar.gz#go1.20.14.linux-amd64.tar.gz#g' Makefile
          sed -i 's#https://gomirrors.org/dl/go/#https://go.dev/dl/#g' Makefile

      - name: Configure firmware options
        run: |
          cd /opt/rt-n56u/trunk

          # 使用 JDC-1.config 模板
          cp -f configs/templates/JDC-1.config .config

          # 用 scripts/config 修改配置（比 sed 更安全）
          # scripts/config --enable CONFIG_FIRMWARE_INCLUDE_OPENSSL_EC
          # scripts/config --enable CONFIG_FIRMWARE_INCLUDE_OPENSSL_EXE
          # scripts/config --enable CONFIG_FIRMWARE_INCLUDE_CURL

          # 打印前几行确认配置
          head -n 20 .config

      - name: Build Firmware
        env:
          TNAME: JDC-1
        run: |
          cd /opt/rt-n56u/trunk
          sudo ./clear_tree
          sudo ./build_firmware_modify $TNAME 0
          sudo mv -f images/*.trx /opt/images/

      - name: Upload packages
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: Padavan2-packages
          path: /opt/images
